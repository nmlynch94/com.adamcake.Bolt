app-id: com.adamcake.Bolt
runtime: org.freedesktop.Platform
runtime-version: &runtime-version "24.08"
x-gl-version: &gl-version "1.4"
x-gl-versions: &gl-versions 24.08;24.08-extra;1.4
x-gl-merge-dirs: &gl-merge-dirs vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
sdk: org.freedesktop.Sdk
command: bolt
build-options:
  cflags: -O3
  cflags-override: true
  cppflags: -O3
  cppflags-override: true
  cxxflags: -O3
  cxxflags-override: true
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --allow=multiarch
  - --env=JAVA_HOME=/app/jre
  - --talk-name=org.freedesktop.Notifications
  - --filesystem=xdg-data/icons:create
  - --filesystem=xdg-run/app/com.discordapp.Discord
  - --filesystem=xdg-run/discord-ipc-0
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21
  - org.freedesktop.Sdk.Extension.node22
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version

  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: *gl-merge-dirs
    download-if: active-gl-driver
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.GL32.Debug:
    directory: lib/debug/lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    merge-dirs: *gl-merge-dirs
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

cleanup:
  - /cef
  - /usr/lib/sdk/node22
modules:
  - name: clang-ccache-symlink
    buildsystem: simple
    build-commands:
      - |
        set -euxo pipefail
        [[ "${CCACHE_DIR}" = "/run/ccache" ]] || exit 0
        ln -svf /usr/bin/ccache /run/ccache/bin/clang
        ln -svf /usr/bin/ccache /run/ccache/bin/clang++
  #
  - name: readelf-symlink
    only-arches: [aarch64]
    buildsystem: simple
    build-commands:
      # Chromium expects to find readelf with its full toolprefix on arm64
      - ln -sfv /usr/bin/readelf "${FLATPAK_DEST}/bin/aarch64-linux-gnu-readelf"
  #
  # - name: extensions
  #   buildsystem: simple
  #   build-commands:
  #     - mkdir -pv "${FLATPAK_DEST}"/chromium/{extensions,native-messaging-hosts,policies}
  #     - for dir in native-messaging-hosts policies; do ln -sfv "${FLATPAK_DEST}/chromium/"{"${dir}",extensions}"/${dir}";
  #       done
  #     - touch "${FLATPAK_DEST}/chromium/extensions/no-mount-stamp"
  #
  - name: dconf
    buildsystem: meson
    config-opts:
      - -Dbash_completion=false
      - -Dman=false
      - -Dvapi=false
    cleanup:
      - /etc
      - /include
      - ca.desrt.dconf.service
      - dconf.service
      - dconf-service
      - '*.pc'
    sources:
      - type: archive
        url: https://download.gnome.org/sources/dconf/0.40/dconf-0.40.0.tar.xz
        sha256: cf7f22a4c9200421d8d3325c5c1b8b93a36843650c9f95d6451e20f0bcb24533
        x-checker-data:
          type: gnome
          name: dconf
          stable-only: true
      # - patches/dconf/_sources.json

  - name: rust-nightly
    buildsystem: simple
    build-commands:
      - cd rust && ./install.sh --prefix=/app/lib/sdk/rust-nightly --without=rust-docs
        --without=rust-docs-json-preview --disable-ldconfig --verbose
      - cd rust-src && ./install.sh --prefix=/app/lib/sdk/rust-nightly --disable-ldconfig
        --verbose
    build-options:
      strip: false
      no-debuginfo: true
    cleanup:
      - '*'
    sources:
      - type: archive
        only-arches:
          - aarch64
        dest: rust
        url: https://static.rust-lang.org/dist/2025-04-21/rust-nightly-aarch64-unknown-linux-gnu.tar.xz
        sha256: 8853c6793fb22b1d005592f584d986262454de838bddc61cedc14a12442795ec
        # x-checker-data:
        #  type: rust
        #  package: rust
        #  channel: nightly
        #  target: aarch64-unknown-linux-gnu
      - type: archive
        only-arches:
          - x86_64
        dest: rust
        url: https://static.rust-lang.org/dist/2025-04-21/rust-nightly-x86_64-unknown-linux-gnu.tar.xz
        sha256: 633ef7829cbfa55f0465f7a9aa616f550ed24f5c06c3eeb174e9be0e5e4a0505
        # x-checker-data:
        #  type: rust
        #  package: rust
        #  channel: nightly
        #  target: x86_64-unknown-linux-gnu
      - type: archive
        dest: rust-src
        url: https://static.rust-lang.org/dist/2025-04-21/rust-src-nightly.tar.xz
        sha256: 76fbba0a950e707c5172deb9e892e3302bab942b8f60b1b9075b4bab01b61407
        x-checker-data:
         type: rust
         package: rust-src
         channel: nightly
         target: '*'

  - name: rust-bindgen
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
      prepend-path: /app/lib/sdk/rust-nightly/bin
      env:
        CARGO_HOME: /run/build/rust-bindgen/cargo
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm 755 target/release/bindgen -t /app/lib/sdk/bindgen/bin
    sources:
      - type: git
        url: https://chromium.googlesource.com/external/github.com/rust-lang/rust-bindgen
        commit: f93d5dfa6d5d7409bea584f3eab38e1fc52b8360
      - ./generated-sources.bindgen.json
    cleanup:
      - '*'

  - name: platform-bootstrap
    buildsystem: simple
    build-commands:
      - |
        set -e
        mkdir -p /app/bin
        mkdir -p /app/lib/i386-linux-gnu
        mkdir -p /app/lib/i386-linux-gnu/GL
        mkdir -p /app/lib/i386-linux-gnu/dri/intel-vaapi-driver
        mkdir -p /app/lib/debug/lib/i386-linux-gnu
        mkdir -p /app/lib/debug/lib/i386-linux-gnu/GL
        install -Dm644 -t /app/etc ld.so.conf
        mkdir -p /app/lib{,32}/ffmpeg
        mkdir -p /app/share/steam/compatibilitytools.d
        mkdir -p /app/utils /app/share/vulkan
        ln -srv /app/{utils/,}share/vulkan/explicit_layer.d
        ln -srv /app/{utils/,}share/vulkan/implicit_layer.d
        mkdir -p /app/links/lib
        ln -srv /app/lib /app/links/lib/x86_64-linux-gnu
        ln -srv /app/lib32 /app/links/lib/i386-linux-gnu
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          # We just make any GL32 extension have higher priority
          include /run/flatpak/ld.so.conf.d/app-*-org.freedesktop.Platform.GL32.*.conf
          /app/lib32
          /app/lib/i386-linux-gnu
          /lib64
  - name: krb5
    buildsystem: simple
    build-commands:
      - autoreconf
      - ./configure --prefix=/app
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    subdir: src
    sources:
      - type: git
        url: https://github.com/krb5/krb5.git
        tag: krb5-1.21.2-final
        commit: 835f6e3d819beb7ee1046f01afb284b54ad54c5f
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk21/install.sh
  - shared-modules/gtk2/gtk2.json
  - name: openssl
    buildsystem: simple
    build-commands:
      - ./config --prefix=/app --openssldir=/app/ssl shared zlib
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install_sw
    sources:
      - type: git
        url: https://github.com/openssl/openssl.git
        tag: OpenSSL_1_1_1w
        commit: e04bd3433fd84e1861bf258ea37928d9845e6a86
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dman=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    cleanup:
      - /include
      - /lib/pkgconfig
      - /lib/debug
      - /lib/girepository-1.0
      - /share/gtk-doc
      - /share/gir-1.0
    sources:
      - type: git
        url: https://github.com/GNOME/libnotify.git
        tag: 0.8.3
        commit: 6083790f9e0f1827147ecd8799c4dced0e86a877
  - name: luajit
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make PREFIX=/app install
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        tag: v2.1.ROLLING
        commit: 2090842410e0ba6f81fad310a77bf5432488249a
  - name: chromium
    buildsystem: simple
    build-commands:
      - patch -p1 --directory=third_party/node < third_party/node/patches/lit_html.patch
      - patch -p1 --directory=third_party/node < third_party/node/patches/typescript.patch
      - patch -p1 --directory=third_party/node/node_modules/chai/ < third_party/node/patches/chai.patch
      - patch -p1 --directory=third_party/node/node_modules/@types/d3/ < third_party/node/patches/chromium_d3_types_index.patch
      - patch -p1 --directory=third_party/node/node_modules/html-minifier/ < third_party/node/patches/html_minifier.patch
      - cmake -S llvm19/llvm -B llvm19/build -G Ninja -DLLVM_ENABLE_PROJECTS="clang;lld;compiler-rt" -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=host
      - cmake --build llvm19/build -j $FLATPAK_BUILDER_N_JOBS
      - cmake --install llvm19/build --prefix llvm19/install
      - ./build/util/lastchange.py -m SKIA_COMMIT_HASH -s third_party/skia --header skia/ext/skia_commit_hash.h
      - /usr/bin/env CC=gcc CXX=g++ python3 gn/build/gen.py
      - /usr/bin/env CC=gcc CXX=g++ ninja -C gn/out -j $FLATPAK_BUILDER_N_JOBS
      - /usr/bin/env CC=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang CXX=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang++ AR=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/llvm-ar python3 cef/tools/gclient_hook.py
      - ./ungoogled-chromium/utils/prune_binaries.py . ungoogled-chromium/pruning.list
      - ./ungoogled-chromium/utils/patches.py apply . ungoogled-chromium/patches
      - ./ungoogled-chromium/utils/domain_substitution.py apply -r ungoogled-chromium/domain_regex.list -f ungoogled-chromium/domain_substitution.list -c domsubcache.tar.gz .
      - /usr/bin/env CC=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang CXX=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang++ AR=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/llvm-ar ninja -k 0 -C out/Release_GN -j $FLATPAK_BUILDER_N_JOBS libcef chrome_sandbox || /usr/bin/env CC=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang CXX=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/clang++ AR=$FLATPAK_BUILDER_BUILDDIR/llvm19/install/bin/llvm-ar ninja -C out/Release_GN -j $FLATPAK_BUILDER_N_JOBS libcef chrome_sandbox
      - python3 ./cef/tools/make_distrib.py --ninja-build --minimal --no-docs --no-archive --output-dir=/app/cef
    build-options:
      env:
        GN_DEFINES: 'angle_build_tests=false angle_enable_commit_id=false blink_symbol_level=0 build_angle_perftests=false build_dawn_tests=false build_with_tflite_lib=false chrome_enable_logging_by_default=false chrome_pgo_phase=0 clang_base_path=/base/llvm21/build dawn_enable_null=false devtools_skip_typecheck=false disable_file_support=true disable_histogram_support=true enable_background_mode=false enable_basic_print_dialog=false enable_browser_speech_service=false enable_concurrent_basic_print_dialogs=false enable_media_remoting=false enable_media_remoting_rpc=false enable_nocompile_tests=false enable_pdf_ink2=false enable_pdf_save_to_drive=false enable_perfetto_unittests=false enable_rlz=false enable_rust_png=false enable_screen_ai_browsertests=false enable_service_discovery=false enable_trace_logging=false enable_vr=false enable_widevine=false generate_about_credits=false gtest_enable_absl_printers=false headless_enable_commands=false headless_mode_policy_supported=false headless_use_policy=false headless_use_prefs=false icu_use_data_file=false include_branded_entitlements=false init_stack_vars=false media_use_openh264=false optional_trace_events_enabled=false ozone_platform_headless=false proprietary_codecs=false safe_browsing_mode=0 skia_enable_skshaper_tests=false tint_build_unittests=false use_sysroot=false use_system_libffi=true v8_deprecation_warnings=false v8_enable_test_features=false v8_enable_webassembly=true v8_imminent_deprecation_warnings=false rust_sysroot_absolute=/base/rust/build/host/stage1 rustc_version=\"rustc 1.92.0-nightly (a0f398e89 2025-10-04)\" rust_bindgen_root=/base/rust-bindgen'
    sources:
      - type: git
        url: https://github.com/chromium/chromium.git
        tag: 139.0.7258.139
        commit: 54b87fe5881df381307c2ef806b8e5e87e8a6790
        disable-submodules: true
      - type: git
        url: https://github.com/chromiumembedded/cef.git
        commit: 9bf44520941a6649be08842de867657bd7c60562
        dest: cef
      - type: git
        url: https://gn.googlesource.com/gn
        commit: ed1abc107815210dc66ec439542bee2f6cbabc00
        dest: gn
      - type: git
        url: https://github.com/llvm/llvm-project.git
        tag: llvmorg-21.1.2
        commit: b708aea0bc7127adf4ec643660699c8bcdde1273
        dest: llvm21
      - type: git
        url: https://github.com/ungoogled-software/ungoogled-chromium.git
        tag: 139.0.7258.138-1
        commit: 803eb8c3f510bc70534910636acfb812b6bb9e0d
        dest: ungoogled-chromium
      - type: archive
        url: https://commondatastorage.googleapis.com/chromium-browser-clang/Linux_x64/rust-toolchain-31e6e8c6c5b6ce62656c922c7384d3376018c980-2-llvmorg-19-init-9433-g76ea5feb.tar.xz
        sha256: 1600c2ec6a8121449ef2c5dd30f1f14330fe4ea769cf7feea2553041da41e952
        dest: third_party/rust-toolchain
        strip-components: 0
        only-arches:
          - "x86_64"
      - type: archive
        url: https://registry.npmjs.org/chai/-/chai-4.2.0.tgz
        sha256: 56947bbb83f2cc755d01071502024088747b609a8f338632ee27649a171cba0a
        dest: third_party/node/node_modules/chai
      - type: archive
        url: https://registry.npmjs.org/mocha/-/mocha-10.0.0.tgz
        sha256: 91c4b9e3d052d73b7cdf297d296e698e8db1137724dd4391cdc5b93ad543283f
        dest: third_party/node/node_modules/mocha
      - third-party-node-modules.yaml
      - chromium-submodules.yaml
      - type: patch
        path: patch/chromium-remove-test-fonts.patch
      - type: patch
        path: patch/chromium-use-system-node.patch
      - type: patch
        path: patch/chromium-dont-update-rust.patch
      - type: patch
        path: patch/blink-fix-clang-template-warning.patch
      - type: patch
        path: patch/blink-fix-gperf.patch
      - type: patch
        path: patch/perfetto-fix-clang-template-warning.patch
      - type: patch
        path: patch/gn-fix-building-in-flathub.patch
      - type: patch
        path: patch/cef-fix-building-in-flathub.patch
        options:
          - --directory=cef
      - type: patch
        path: patch/libcef-fix-building-without-safebrowsing.patch
        options:
          - --directory=cef
      - type: patch
        path: patch/cef-fix-arm64-requires-sysroots.patch
        options:
          - --directory=cef
      - type: patch
        path: patch/cef-fix-doesn-t-detect-aarch64.patch
        options:
          - --directory=cef
      - type: patch
        path: patch/cef-no-fortify.patch
        options:
          - --directory=cef
      - type: patch
        path: patch/ungoogled-chromium-ignore-nonexistent-binaries.patch
        options:
          - --directory=ungoogled-chromium
      - type: patch
        path: patch/ungoogled-chromium-adjust-for-cef.patch
        options:
          - --directory=ungoogled-chromium
      - type: patch
        paths:
          - org.chromium.Chromium/patches/chromium/flatpak-Add-initial-sandbox-support.patch
          - org.chromium.Chromium/patches/chromium/flatpak-Adjust-paths-for-the-sandbox.patch
          - org.chromium.Chromium/patches/chromium/x11-Set-_NET_WM_BYPASS_COMPOSITOR-for-fullscreen.patch
          - org.chromium.Chromium/patches/chromium/memory-Enable-the-tab-discards-feature.patch
          - org.chromium.Chromium/patches/chromium/Enable-accelerated-mjpeg-decode-on-Linux.patch
          - org.chromium.Chromium/patches/chromium/ffmpeg-Don-t-lie-about-AAC-and-H264-decoders-when-not-avai.patch
          - org.chromium.Chromium/patches/chromium/Remove-the-ability-to-create-desktop-shortcuts.patch
          - org.chromium.Chromium/patches/chromium/Use-CHROME_WRAPPER-as-the-executable-on-restart.patch
          - org.chromium.Chromium/patches/chromium/Enable-new-dtags-on-non-component-builds.patch
          - org.chromium.Chromium/patches/chromium/Add-support-for-respecting-system-proxy-settings-when-runn.patch
          - org.chromium.Chromium/patches/chromium/Clang-build-script-Disable-hwasan.patch
          - org.chromium.Chromium/patches/chromium/clang-build-script-Support-disabling-the-bundled-libxml2.patch
          - org.chromium.Chromium/patches/chromium/Clang-build-script-Don-t-build-against-the-sysroot.patch
          - org.chromium.Chromium/patches/chromium/Clang-build-script-add-support-for-building-a-subset-of-ta.patch
  - name: wine-staging
    buildsystem: simple
    build-commands:
      - mkdir -p wine-staging
      - tar xf wine-staging.tar.xz -C wine-staging --strip-components=1
      - cp -r wine-staging/bin/* /app/bin/
      - cp -r wine-staging/lib/* /app/lib/
      - cp -r wine-staging/share/* /app/share/
    sources:
      - type: file
        url: https://github.com/Kron4ek/Wine-Builds/releases/download/10.15/wine-10.15-staging-amd64.tar.xz
        dest-filename: wine-staging.tar.xz
        sha256: 3c6d14a58cd67ef7250967eadb84be7d0ef5f789ebacaed424bc5f3da51293b4
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Kron4ek/Wine-Builds/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="wine-" + $version + "-staging-amd64.tar.xz")
            | .browser_download_url
  - name: bolt
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCEF_ROOT=/app/cef/dist
      - -DBOLT_META_NAME=com.adamcake.Bolt
      - -DBOLT_BINDIR=bin
      - -DBOLT_LIBDIR=lib
      - -DBOLT_SHAREDIR=share
    sources:
      - type: git
        url: https://github.com/Adamcake/Bolt.git
        tag: 0.20.0
        commit: fb8e949c03f053ea947dae76e39010a1084a625a
